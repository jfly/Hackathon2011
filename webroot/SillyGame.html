<html>
	<head>

		<title>Hackathon2011</title>

		<script type='text/javascript' src='stacktrace.js'></script>
		<script type='text/javascript' src='assert.js'></script>
		<script type='text/javascript' src='/nowjs/now.js'></script>
		<script type='text/javascript' src='jquery-1.6.4.js'></script>

		<script type='text/javascript' src='StatusBar.js'></script>
		<script type='text/javascript' src='GameMaster.js'></script>
		<script type='text/javascript' src='GameMasterGui.js'></script>
		<script type='text/javascript' src='ButtonGame.js'></script>

		<script type='text/javascript'>
			(function() {
			StatusBar.setError('init', 'Connecting...');
			var gm, gmGui;
			now.ready(function() {
				StatusBar.setError('init', null);
				// This function appears to get called multiple times. 
				// One situation in which this happens is when nowjs
				// reestablishes a connection with the server.
				if(!gm) {
					gm = new GameMaster.GameMaster();
					gmGui = new GameMasterGui.GameMasterGui(gm);
				}

				gm.joinChannel();
			});

			/* TODO - merge w/ gm.errors somehow
			var disconnected = true;
			var interestingEvents = { 'disconnect': "Disconnected",
				'reconnect': null,
				'reconnect_failed': null,
				'connect_failed': null,
				'error': null,
				'retry': null };
			for(var i = 0; i < interestingEvents.length; i++) {
				var interestingEvent = interestingEvents[i];
				now.core.on(interestingEvent, function(interestingEvent) {
					if(interestingEvent == 'disconnect') {
						disconnected = true;
					}
					connectionStatus.show();
					connectionStatus.text(interestingEvent);
				}.bind(null, interestingEvent));
			}
			*/

			var pingerPollerRunning = false;
			now.ready(function() {
				disconnected = false;

				if(pingerPollerRunning) {
					return;
				}
				pingerPollerRunning = true;

				var HEARTBEAT_PERIOD = 2000;
				var HEARTBEAT_THRESHOLD = 2*HEARTBEAT_PERIOD;

				var lastHeartbeat = new Date().getTime();
				function pinger() {
					now.ping(function() {
						lastHeartbeat = new Date().getTime();
						setTimeout(pinger, HEARTBEAT_PERIOD);
					});
				}
				pinger();

				function poller() {
					var timeSinceLastHeartbeat = new Date().getTime() - lastHeartbeat;
					if(timeSinceLastHeartbeat > HEARTBEAT_THRESHOLD) {
						StatusBar.setError('poller', 'Having difficulty talking to server');
					} else {
						StatusBar.setError('poller', null);
					}
					setTimeout(poller, HEARTBEAT_PERIOD/2);
				}
				poller();
			});


			})();
		</script>

		<link rel="stylesheet" href="GameMaster.css" type="text/css" />
		<link rel="stylesheet" href="StatusBar.css" type="text/css" />
		</style>
	</head>
	<body>
	</body>
</html>
